-- create schema for new scenario
CREATE SCHEMA IF NOT EXISTS results_nhsl_social_fabric;

-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype1 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype1 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '1')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '1') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '1');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype2 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype2 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '2')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '2') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '2');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype3 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype3 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '3')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '3') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '3');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype4 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype4 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '4')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '4') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '4');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype5 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype5 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '5')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '5') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '5');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype6 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype6 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '6')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '6') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '6');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype7 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype7 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '7')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '7') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '7');



-- create social vulnerability indicators
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype8 CASCADE;
CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype8 AS 

-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.1 Housing Conditions
(SELECT 
b.sauidt AS "Sauid",

0 AS "SVlt_Score",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) +  (CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) +
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + 
 (CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END)
 AS "VHt_Score",

CAST(CAST(ROUND(CAST(b.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_PopHa",
CAST(CAST(ROUND(CAST(c.pop_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_PopHa",
(CASE WHEN c.pop_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHt_PopHa",

CAST(CAST(ROUND(CAST(b.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Pre1975",
CAST(CAST(ROUND(CAST(c.pre_1975 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Pre1975",
(CASE WHEN c.pre_1975 >= (SELECT pre_1975_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHtPre1975",

CAST(CAST(ROUND(CAST(b.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NSuit",
CAST(CAST(ROUND(CAST(c.hshld_nsuit AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NSuit",
(CASE WHEN c.hshld_nsuit >= (SELECT hshld_nsuit_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHt_NSuit",

CAST(CAST(ROUND(CAST(b.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_MntnAge",
CAST(CAST(ROUND(CAST(c.hshld_mntnage AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_MntnAge",
(CASE WHEN c.hshld_mntnage >= (SELECT hshld_mntnage_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHt_MntnAge",

CAST(CAST(ROUND(CAST(b.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Mntn1",
CAST(CAST(ROUND(CAST(c.hshld_mntn1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Mntn1",
(CASE WHEN c.hshld_mntn1 >= (SELECT hshld_mntn1_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHt_Mntn1",

CAST(CAST(ROUND(CAST(b.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_Renter",
CAST(CAST(ROUND(CAST(c.renter AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_Renter",
(CASE WHEN c.renter >= (SELECT renter_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHt_Renter",

CAST(CAST(ROUND(CAST(b.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VH_NonResHa",
CAST(CAST(ROUND(CAST(c.bus_ha AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VHn_NonResHa",
(CASE WHEN c.bus_ha >= (SELECT pop_ha_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VHt_NonResHa",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.2 Family Structure
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END)  + (CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) +
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + 
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_Score",  

CAST(CAST(ROUND(CAST(b.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LivAlone",
CAST(CAST(ROUND(CAST(c.live_alone AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LivAlone",
(CASE WHEN c.live_alone >= (SELECT live_alone_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_LivAlone",

CAST(CAST(ROUND(CAST(b.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_LonPar3Kids",
CAST(CAST(ROUND(CAST(c.lonepar3kids AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_LonPar3Kids",
(CASE WHEN c.lonepar3kids >= (SELECT lonepar3kids_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_LonPar3Kids",

CAST(CAST(ROUND(CAST(b.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_FamGT5",
CAST(CAST(ROUND(CAST(c.fam_gt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_FamGT5",
(CASE WHEN c.fam_gt5 >= (SELECT fam_gt5_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_FamGT5",

CAST(CAST(ROUND(CAST(b.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_MovedLT1",
CAST(CAST(ROUND(CAST(c.moved_lt1 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_MovedLT1",
(CASE WHEN c.moved_lt1 >= (SELECT moved_lt1_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_MovedLT1",

CAST(CAST(ROUND(CAST(b.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_ImmLT5",
CAST(CAST(ROUND(CAST(c.imm_lt5 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_Imm_LT5",
(CASE WHEN c.imm_lt5 >= (SELECT imm_lt5_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_ImmLT5",

CAST(CAST(ROUND(CAST(b.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VF_NoWrkPlace",
CAST(CAST(ROUND(CAST(c.nowrkplace AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VFn_NoWrkPlace",
(CASE WHEN c.nowrkplace >= (SELECT nowrkplace_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VFt_NoWrkPlace",


-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.3 Individual Autonomy
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) +
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + 
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_Score",

CAST(CAST(ROUND(CAST(b.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoEngFr",
CAST(CAST(ROUND(CAST(c.no_engfr AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoEngFr",
(CASE WHEN c.no_engfr >= (SELECT no_engfr_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_NoEngFr",

CAST(CAST(ROUND(CAST(b.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_NoSecED",
CAST(CAST(ROUND(CAST(c.nosec_school AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_NoSecED",
(CASE WHEN c.nosec_school >= (SELECT nosec_school_t FROM sovi.sovi_thresholds WHERE sactype = '8')THEN 1 ELSE 0 END) AS "VAt_NoSecED",

CAST(CAST(ROUND(CAST(b.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeGT65",
CAST(CAST(ROUND(CAST(c.age_gt65 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeGT65",
(CASE WHEN c.age_gt65 >= (SELECT age_gt65_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_AgeGT65",

CAST(CAST(ROUND(CAST(b.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeLT6",
CAST(CAST(ROUND(CAST(c.age_lt6 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeLT6",
(CASE WHEN c.age_lt6 >= (SELECT age_lt6_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_AgeLT6",

CAST(CAST(ROUND(CAST(b.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Indigenous",
CAST(CAST(ROUND(CAST(c.indigenous AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Indigenous",
(CASE WHEN c.indigenous >= (SELECT indigenous_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_Indigenous",

CAST(CAST(ROUND(CAST(b.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_VisMinority",
CAST(CAST(ROUND(CAST(c.vis_min AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_VisMinority",
(CASE WHEN c.vis_min >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_VisMinority",

CAST(CAST(ROUND(CAST(b.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_AgeMedian",
CAST(CAST(ROUND(CAST(c.age_median AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_AgeMedian",
(CASE WHEN c.age_median >= (SELECT agemedian_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_AgeMedian",

CAST(CAST(ROUND(CAST(b.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_Health",
CAST(CAST(ROUND(CAST(c.health_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_Health",
(CASE WHEN c.health_job >= (SELECT health_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_Health",
 
CAST(CAST(ROUND(CAST(b.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VA_PubTrans",
CAST(CAST(ROUND(CAST(c.pub_trans AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VAn_PubTrans",
(CASE WHEN c.pub_trans >= (SELECT vis_min_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VAt_PubTrans",
 
-- 1.0 Human Settlement
-- 1.3 Social Fabric
-- 1.3.4 Financial Agency
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) +
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) +
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) + (CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_Score", 

CAST(CAST(ROUND(CAST(b.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_ShltrGT30",
CAST(CAST(ROUND(CAST(c.shltr_gt30 AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_ShltrGT30",
(CASE WHEN c.shltr_gt30 >= (SELECT shltr_gt30_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_ShltrGT30",

CAST(CAST(ROUND(CAST(b.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_LowIncDec",
CAST(CAST(ROUND(CAST(c.inc_lowdecile AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_LowIncDec",
(CASE WHEN c.inc_lowdecile >= (SELECT inc_lowdecile_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_LowIncDec",

CAST(CAST(ROUND(CAST(b.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Unemployed",
CAST(CAST(ROUND(CAST(c.unemployed AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Unemployed",
(CASE WHEN c.unemployed >= (SELECT unemployed_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_Unemployed",

CAST(CAST(ROUND(CAST(b.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IncEmploy",
CAST(CAST(ROUND(CAST(c.employ_inc AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IncEmploy",
(CASE WHEN c.employ_inc >= (SELECT employ_inc_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_IncEmploy",

CAST(CAST(ROUND(CAST(b.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_IndivInc",
CAST(CAST(ROUND(CAST(c.inc_indv AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_IndivInc",
(CASE WHEN c.inc_indv >= (SELECT inc_indv_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_IndivInc",

CAST(CAST(ROUND(CAST(b.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_HshldInc",
CAST(CAST(ROUND(CAST(c.inc_hshld AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_HshldInc",
(CASE WHEN c.inc_hshld >= (SELECT inc_hshld_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_HshldInc",
 
CAST(CAST(ROUND(CAST(b.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_Retail",
CAST(CAST(ROUND(CAST(c.retail_job AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_Retail",
(CASE WHEN c.retail_job >= (SELECT retail_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_Retail",

CAST(CAST(ROUND(CAST(b.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkNone",
CAST(CAST(ROUND(CAST(c.work_none AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkNone",
(CASE WHEN c.work_none >= (SELECT work_none_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_WorkNone",

CAST(CAST(ROUND(CAST(b.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VE_WorkPart",
CAST(CAST(ROUND(CAST(c.work_parttime AS NUMERIC),6) AS FLOAT) AS NUMERIC) AS "VEn_WorkPart",
(CASE WHEN c.work_parttime >= (SELECT work_parttime_t FROM sovi.sovi_thresholds WHERE sactype = '8') THEN 1 ELSE 0 END) AS "VEt_WorkPart",

d."PRUID" AS "pruid",
d."PRNAME" AS "prname",
d."ERUID" AS "eruid",
d."ERNAME" AS "ername",
d."CDUID" AS "cduid",
d."CDNAME" AS "cdname",
d."CSDUID" AS "csduid",
d."CSDNAME" AS "csdname",
d."CFSAUID" AS "fsauid",
d."DAUIDt" AS "dauid",
d."SACCODE" AS "saccode",
d."SACTYPE" AS "sactype",
d.geom AS "geom_poly"
--d.geompoint AS "geom_point"

FROM sovi.sovi_census_canada b 
LEFT JOIN sovi.sovi_index_canada c ON b.sauidt = c.sauidt
LEFT JOIN boundaries."Geometry_SAUID" d ON b.sauidt = d."SAUIDt"
WHERE d."SACTYPE" = '8');




-- combine tables for sactype into 1
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl CASCADE;

CREATE TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype1
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype2
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype3
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype4
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype5
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype6
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype7
UNION
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype8;


-- update SVIt_Score column
UPDATE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl
SET "SVlt_Score" = "VHt_Score" + "VFt_Score" + "VAt_Score" + "VEt_Score";

-- create index
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_sauid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl("Sauid");
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_pruid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(pruid);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_prname_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(prname);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_eruid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(eruid);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_ername_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(ername);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_cduid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(cdname);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_cdname_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(cdname);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_csduid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(csduid);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_csdname_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(csdname);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_fsauid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(fsauid);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_dauid_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl(dauid);
CREATE INDEX nhsl_social_fabric_all_indicators_s_tbl_geom_idx ON results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl USING GIST(geom_poly);

-- add pk
ALTER TABLE results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl ADD PRIMARY KEY("Sauid");

-- create views for province
DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl;

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nl CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nl AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='10';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_pe CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_pe AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='11';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_ns CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_ns AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='12';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nb CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nb AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='13';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_qc CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_qc AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='24';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_on CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_on AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='35';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_mb CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_mb AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='46';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sk CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sk AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='47';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_ab CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_ab AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='48';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_bc CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_bc AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='59';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_yt CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_yt AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='60';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nt CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nt AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='61';

DROP VIEW IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nu CASCADE;
CREATE VIEW results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_nu AS 
SELECT * FROM results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_tbl WHERE pruid ='62';


--drop intermediate tables
DROP TABLE IF EXISTS results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype1,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype2,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype3,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype4,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype5,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype6,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype7,
results_nhsl_social_fabric.nhsl_social_fabric_all_indicators_s_sactype8;